import { useEffect, useCallback } from "react";
import { ApiKeyModal } from "./components/ApiKeyModal";
import { useApiKeys, ApiKeys } from "./hooks/useApiKeys";
import { StrategyEditor } from "./components/StrategyEditor";
import { BacktestResults } from "./components/BacktestResults";
import { StockPeriodSelector } from "./components/StockPeriodSelector";
import { ProgressBar } from "./components/ProgressBar";
import { StrategyAST } from "./types";

// Custom hooks
import { useAppState } from "./hooks/useAppState";
import { useDataFetching } from "./hooks/useDataFetching";
import { useBacktestWorker } from "./hooks/useBacktestWorker";
import { useBacktestExecution } from "./hooks/useBacktestExecution";

export default function App() {
  const { keys: apiKeys, updateKeys } = useApiKeys();

  // Use centralized state management
  const { state, actions } = useAppState();

  const handleJQuantsTokenRefreshed = useCallback(
    (newIdToken: string, newRefreshToken?: string) => {
      const updates: Partial<ApiKeys> = { jquants_id: newIdToken };
      if (newRefreshToken) {
        updates.jquants_refresh = newRefreshToken;
      }
      updateKeys(updates);
      console.log("App: J-Quants tokens updated in state and session storage.");
    },
    [updateKeys]
  );

  // Data fetching hook
  const { fetchData } = useDataFetching({
    apiKeys,
    onTokenRefreshed: handleJQuantsTokenRefreshed,
    onProgressUpdate: (value, message) =>
      actions.setProgress({ value, message }),
    onDataError: actions.setDataError,
    onDataSuccess: actions.setOhlcData,
    onLoadingChange: actions.setLoadingData,
    validatedDsl: state.validatedDsl,
  });

  // Backtest worker hook
  const { runBacktest } = useBacktestWorker({
    onProgress: (value, message) => actions.setProgress({ value, message }),
    onResult: actions.setBacktestResult,
    onError: actions.setBacktestError,
    onLoadingChange: actions.setBacktestLoading,
  });

  // Backtest execution hook
  const { executeBacktest } = useBacktestExecution({
    onProgress: (value, message) => actions.setProgress({ value, message }),
    onError: actions.setBacktestError,
    runBacktest,
  });

  // Open modal if JQuants key is not set on initial load
  useEffect(() => {
    if (!apiKeys.jquants_refresh) {
      actions.setApiKeyModalOpen(true);
    }
  }, [apiKeys.jquants_refresh, actions.setApiKeyModalOpen]);

  const handleDataConfigSubmit = useCallback(
    async (codes: string[], startDate: string, endDate: string) => {
      if (!apiKeys.jquants_refresh) {
        actions.setDataError(
          "E2001: J-Quants Refresh TokenãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚"
        );
        actions.setApiKeyModalOpen(true);
        actions.setProgress({ value: 0, message: "APIã‚­ãƒ¼æœªè¨­å®š" });
        return;
      }

      actions.setDataConfig({ codes, startDate, endDate });

      const success = await fetchData(codes, startDate, endDate);

      // If data fetching was successful and we have a validated DSL, set up run config
      if (success && state.validatedDsl) {
        actions.setRunConfig({
          dsl: state.validatedDsl,
          codes: Object.keys(state.ohlcData),
          startDate,
          endDate,
        });
      }
    },
    [apiKeys, fetchData, state.validatedDsl, state.ohlcData, actions.setDataError, actions.setApiKeyModalOpen, actions.setProgress, actions.setDataConfig, actions.setRunConfig]
  );

  const handleStrategyValidated = useCallback(
    (dsl: StrategyAST) => {
      actions.setValidatedDsl(dsl);
      actions.setShowDsl(true);
      actions.resetBacktest();
      actions.setProgress({
        value: 60,
        message: "æˆ¦ç•¥æ¤œè¨¼å®Œäº†ã€‚ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...",
      });

      if (state.dataConfig && Object.keys(state.ohlcData).length > 0) {
        actions.setRunConfig({
          dsl,
          codes: Object.keys(state.ohlcData),
          startDate: state.dataConfig.startDate,
          endDate: state.dataConfig.endDate,
        });
      }
    },
    [state.dataConfig, state.ohlcData, actions.setValidatedDsl, actions.setShowDsl, actions.resetBacktest, actions.setProgress, actions.setRunConfig]
  );

  // Effect to run backtest when runConfig changes
  useEffect(() => {
    if (!state.runConfig || Object.keys(state.ohlcData).length === 0) {
      if (
        state.isBacktestLoading &&
        (!state.runConfig || Object.keys(state.ohlcData).length === 0)
      ) {
        actions.setBacktestLoading(false);
        if (!state.runConfig) {
          actions.setProgress({
            value: state.progress.value,
            message: "æˆ¦ç•¥ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
          });
        }
        if (Object.keys(state.ohlcData).length === 0) {
          actions.setProgress({
            value: state.progress.value,
            message: "OHLCãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
          });
        }
      }
      return;
    }

    actions.setBacktestLoading(true);
    actions.resetBacktest();

    // Execute backtest asynchronously to avoid UI blocking
    const runConfig = state.runConfig; // Store in local variable for null safety
    if (runConfig) {
      (async () => {
        await executeBacktest(runConfig.dsl, state.ohlcData);
      })();
    }
  }, [
    state.runConfig,
    state.ohlcData,
    state.isBacktestLoading,
    executeBacktest,
    actions.setBacktestLoading,
    actions.resetBacktest,
    actions.setProgress,
  ]);

  return (
    <div className="container mx-auto p-4 space-y-6">
      <ProgressBar
        progress={state.progress.value}
        message={state.progress.message}
      />

      <header className="flex justify-between items-center py-2 border-b mb-4">
        <h1 className="text-2xl font-bold">
          æ—¥æœ¬æ ªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ»ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        </h1>
        <button
          onClick={() => actions.setApiKeyModalOpen(true)}
          className="px-3 py-2 border rounded text-sm hover:bg-gray-100"
        >
          APIã‚­ãƒ¼è¨­å®š
        </button>
      </header>

      <ApiKeyModal
        isOpen={state.isApiKeyModalOpen}
        onClose={() => actions.setApiKeyModalOpen(false)}
      />

      {!apiKeys.jquants_refresh && !state.isApiKeyModalOpen && (
        <div className="p-4 bg-yellow-100 text-yellow-800 rounded">
          J-Quants Refresh
          TokenãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å³ä¸Šã®ã€ŒAPIã‚­ãƒ¼è¨­å®šã€ã‹ã‚‰ã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </div>
      )}

      {apiKeys.jquants_refresh && (
        <>
          <section className="space-y-4">
            <h2 className="text-xl font-semibold">1. éŠ˜æŸ„ãƒ»æœŸé–“ã®é¸æŠ</h2>
            {!state.dataConfig ? (
              <StockPeriodSelector onSubmit={handleDataConfigSubmit} />
            ) : (
              <div className="bg-gray-50 p-4 rounded">
                <div className="flex justify-between items-start">
                  <div>
                    <p className="font-medium">é¸æŠæ¸ˆã¿:</p>
                    <p>éŠ˜æŸ„: {state.dataConfig.codes.join(", ")}</p>
                    <p>
                      æœŸé–“: {state.dataConfig.startDate} ã€œ{" "}
                      {state.dataConfig.endDate}
                    </p>
                  </div>
                  <button
                    onClick={() => {
                      actions.resetData();
                    }}
                    className="text-blue-600 hover:text-blue-800"
                  >
                    å¤‰æ›´
                  </button>
                </div>
                {state.isLoadingData && (
                  <p className="mt-2">
                    ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...{" "}
                    {state.progress.message.includes("OHLCãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­")
                      ? state.progress.message.split(": ")[1]
                      : ""}
                  </p>
                )}
                {state.dataError && (
                  <p className="mt-2 text-red-600">ã‚¨ãƒ©ãƒ¼: {state.dataError}</p>
                )}
                {!state.isLoadingData &&
                  !state.dataError &&
                  Object.keys(state.ohlcData).length > 0 && (
                    <p className="mt-2 text-green-600">
                      âœ“ ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† ({Object.keys(state.ohlcData).length}/
                      {state.dataConfig?.codes?.length || 0}éŠ˜æŸ„)
                      {Object.keys(state.ohlcData).length <
                        (state.dataConfig?.codes?.length || 0) && (
                        <span className="text-yellow-600 ml-2">
                          ä¸€éƒ¨éŠ˜æŸ„ã®å–å¾—ã«å¤±æ•—
                        </span>
                      )}
                    </p>
                  )}
              </div>
            )}
          </section>

          <section className="space-y-4">
            <h2 className="text-xl font-semibold">2. æˆ¦ç•¥ã®å®šç¾©</h2>
            <StrategyEditor
              onStrategySubmit={handleStrategyValidated}
              apiKeys={apiKeys}
            />
            {state.showDsl && state.validatedDsl && (
              <div className="mt-4 p-3 bg-gray-100 rounded">
                <h3 className="font-semibold">æ¤œè¨¼æ¸ˆã¿DSL:</h3>
                <pre className="text-sm whitespace-pre-wrap">
                  {JSON.stringify(state.validatedDsl, null, 2)}
                </pre>
              </div>
            )}

            {/* Debug Section */}
            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
              <h3 className="font-semibold text-yellow-800 mb-2">
                ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«
              </h3>
              <div className="space-x-2">
                <button
                  onClick={async () => {
                    console.log("=== JQuants API Debug Test ===");
                    console.log("Current API Keys:", {
                      hasJQuantsId: !!apiKeys.jquants_id,
                      hasJQuantsRefresh: !!apiKeys.jquants_refresh,
                      jQuantsIdLength: apiKeys.jquants_id?.length || 0,
                      jQuantsRefreshLength:
                        apiKeys.jquants_refresh?.length || 0,
                    });

                    if (apiKeys.jquants_refresh) {
                      const { refreshJQuantsIdTokenLogic } = await import(
                        "./lib/fetchJQuants"
                      );
                      const result = await refreshJQuantsIdTokenLogic(
                        apiKeys.jquants_refresh
                      );
                      console.log("Token refresh result:", result);
                    } else {
                      console.log("No refresh token available for testing");
                    }
                  }}
                  className="px-3 py-1 bg-yellow-200 text-yellow-800 rounded text-sm hover:bg-yellow-300"
                >
                  JQuantsãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆ
                </button>
                <button
                  onClick={async () => {
                    console.log("=== Proxy Test ===");
                    try {
                      const response = await fetch("/jquants-api/v1/info", {
                        method: "GET",
                        headers: { "Content-Type": "application/json" },
                      });
                      console.log(
                        "Proxy test response status:",
                        response.status
                      );
                      const text = await response.text();
                      console.log(
                        "Proxy test response:",
                        text.substring(0, 200)
                      );
                    } catch (error) {
                      console.error("Proxy test error:", error);
                    }
                  }}
                  className="px-3 py-1 bg-blue-200 text-blue-800 rounded text-sm hover:bg-blue-300"
                >
                  ãƒ—ãƒ­ã‚­ã‚·ãƒ†ã‚¹ãƒˆ
                </button>
              </div>
            </div>
          </section>

          {(state.isBacktestLoading ||
            state.backtestResult ||
            state.backtestError) &&
            state.runConfig && (
              <section className="space-y-4">
                <h2 className="text-xl font-semibold">3. ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ</h2>
                {state.backtestResult && (
                  <BacktestResults
                    dsl={state.runConfig.dsl}
                    codes={state.runConfig.codes}
                    startDate={state.runConfig.startDate}
                    endDate={state.runConfig.endDate}
                    apiKey={apiKeys.openai || ""}
                    ohlcDataProp={state.ohlcData}
                    onProgressUpdate={(value, message) =>
                      actions.setProgress({ value, message })
                    }
                    backtestResponse={state.backtestResult}
                    isLoading={state.isBacktestLoading}
                    error={state.backtestError}
                  />
                )}
                {state.backtestError && (
                  <div className="p-4 bg-red-100 text-red-700 rounded">
                    <p className="font-bold">ã‚¨ãƒ©ãƒ¼:</p>
                    <p>{state.backtestError}</p>
                  </div>
                )}
              </section>
            )}
        </>
      )}
    </div>
  );
}
